{% extends "base.html" %}

{% block title %}Admin Dashboard - TurfEase{% endblock %}

{% block content %}

<!-- User Dashboard Sections (for admins) -->
<div class="row mb-4">
    <div class="col-lg-8">
        <!-- Recent Bookings -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Your Recent Bookings</h5>
            </div>
            <div class="card-body">
                {% if bookings %}
                    <ul class="list-group">
                        {% for booking in bookings[:5] %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                <strong>{{ booking.turf_side }}</strong> on <strong>{{ booking.booking_date }}</strong>
                                at <strong>{{ booking.time_slot }}</strong>
                                <span class="badge bg-light text-dark ms-2">{{ booking.status }}</span>
                            </span>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="alert alert-info mb-0">No recent bookings.</div>
                {% endif %}
            </div>
        </div>
        <!-- Book Now Button -->
        <div class="d-grid mb-3">
            <a href="{{ url_for('book_turf') }}" class="btn btn-success btn-lg">
                <i class="fas fa-calendar-plus me-2"></i>Book Now
            </a>
        </div>
    </div>
    <div class="col-lg-4">
        <!-- Notices -->
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-bullhorn me-2"></i>Notices</h5>
            </div>
            <div class="card-body">
                {% if notices %}
                    <ul class="list-group">
                        {% for notice in notices %}
                        <li class="list-group-item">
                            <strong>{{ notice.title }}</strong>
                            <br>
                            <span class="text-muted small">{{ notice.created_at }}</span>
                            <div>{{ notice.content }}</div>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="alert alert-info mb-0">No notices yet.</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Admin Dashboard Features -->
<div class="row">
    <div class="col-12">
        <!-- Dashboard Stats -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h6 class="text-muted">Total Bookings</h6>
                        <h3>{{ total_bookings }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h6 class="text-muted">Approved Bookings</h6>
                        <h3>{{ approved_bookings }}</h3>
                        <div class="text-success">
                            {{ ((approved_bookings / total_bookings * 100) | round(1)) if total_bookings > 0 else 0 }}%
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h6 class="text-muted">Pending Bookings</h6>
                        <h3>{{ pending_count }}</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Approvals -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-hourglass-half me-2"></i>Pending Booking Approvals</h5>
            </div>
            <div class="card-body">
                {% if pending_bookings %}
                    <ul class="list-group">
                        {% for booking in pending_bookings %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                <strong>{{ booking.name }}</strong> ({{ booking.division }})<br>
                                <strong>{{ booking.turf_side }}</strong> on <strong>{{ booking.booking_date }}</strong>
                                at <strong>{{ booking.time_slot }}</strong>
                            </span>
                            <span>
                                <a href="{{ url_for('admin_booking_action', booking_id=booking.id, action='approve') }}" class="btn btn-success btn-sm">Approve</a>
                                <a href="{{ url_for('admin_booking_action', booking_id=booking.id, action='decline') }}" class="btn btn-danger btn-sm">Decline</a>
                            </span>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="alert alert-info mb-0">No pending bookings.</div>
                {% endif %}
            </div>
        </div>

        <!-- Weekly Calendar -->
        <div class="card mt-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-calendar-week me-2"></i>This Week's Schedule</h5>
            </div>
            <div class="card-body table-responsive">
                <!-- Week Navigation Controls -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <a class="btn btn-outline-primary" href="{{ url_for('admin_dashboard', week=week_offset-1) }}">
                        &laquo; Previous Week
                    </a>
                    <form method="get" class="d-inline-block">
                        <label for="week_start" class="me-2 fw-bold">Go to week starting:</label>
                        <input type="date" id="week_start" name="week_start"
                               value="{{ start_of_week }}"
                               min="2020-01-01" max="2100-12-31"
                               class="form-control d-inline-block" style="width: 180px;">
                        <button type="submit" class="btn btn-primary ms-2">Go</button>
                    </form>
                    <a class="btn btn-outline-primary" href="{{ url_for('admin_dashboard', week=week_offset+1) }}">
                        Next Week &raquo;
                    </a>
                </div>
                <table class="table table-bordered align-middle text-center">
                    <thead>
                        <tr>
                            <th>Date</th>
                            {% for turf in TURF_SIDES %}
                                <th>{{ turf }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for day, turfs in calendar.items() %}
                        <tr>
                            <td>
                                <strong>{{ day }}</strong>
                                <br>
                                <span class="text-muted">{{ day | datetimeformat('A, d M') }}</span>
                            </td>
                            {% for turf in TURF_SIDES %}
                            <td>
                                {% if turfs[turf] %}
                                    {% for booking in turfs[turf] %}
                                        <div class="border rounded p-2 mb-2 {% if booking.status == 'approved' %}bg-success text-white{% elif booking.status == 'pending' %}bg-warning text-dark{% else %}bg-light text-muted{% endif %}">
                                            <strong>{{ booking.time_slot }}</strong><br>
                                            <span class="small">{{ booking.name }}</span>
                                            <span class="badge bg-light text-dark ms-1">{{ booking.status }}</span>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-muted">No bookings</span>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
let currentBookingId = null;

function approveBooking(bookingId) {
    if (confirm('Are you sure you want to approve this booking?')) {
        window.location.href = `/admin/booking/${bookingId}/approve`;
    }
}

function declineBooking(bookingId) {
    currentBookingId = bookingId;
    const modal = new bootstrap.Modal(document.getElementById('declineModal'));
    modal.show();
}

function confirmDecline() {
    const reason = document.getElementById('declineReason').value.trim();
    if (!reason) {
        alert('Please provide a reason for declining the booking.');
        return;
    }
    
    const url = `/admin/booking/${currentBookingId}/decline?reason=${encodeURIComponent(reason)}`;
    window.location.href = url;
}

// Show toast notification if there's a success message
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success')) {
        const toast = new bootstrap.Toast(document.getElementById('successToast'));
        document.getElementById('toastMessage').textContent = 'Booking action completed successfully!';
        toast.show();
    }
    
    // Auto-refresh every 30 seconds for new bookings
    setInterval(function() {
        // Only refresh if there are no modals open
        if (!document.querySelector('.modal.show')) {
            window.location.reload();
        }
    }, 30000);
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Escape key to close modals
    if (e.key === 'Escape') {
        const modals = document.querySelectorAll('.modal.show');
        modals.forEach(modal => {
            bootstrap.Modal.getInstance(modal).hide();
        });
    }
});
</script>
{% endblock %}