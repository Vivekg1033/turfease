{% extends "base.html" %}

{% block title %}Chat - TurfEase{% endblock %}

{% block extra_head %}
<style>
    .chat-container {
        height: 600px;
        display: flex;
        flex-direction: column;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px 10px 0 0;
    }
    
    .message {
        margin-bottom: 15px;
        animation: fadeIn 0.3s ease-in;
    }
    
    .message.own {
        text-align: right;
    }
    
    .message-bubble {
        display: inline-block;
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 20px;
        word-wrap: break-word;
    }
    
    .message.own .message-bubble {
        background: var(--primary-color);
        color: white;
        border-bottom-right-radius: 5px;
    }
    
    .message.other .message-bubble {
        background: white;
        color: #333;
        border: 1px solid #e5e7eb;
        border-bottom-left-radius: 5px;
    }
    
    .message.admin .message-bubble {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-left-radius: 5px;
    }
    
    .message-info {
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 5px;
    }
    
    .chat-input {
        background: white;
        border-radius: 0 0 10px 10px;
        border-top: 1px solid #e5e7eb;
        padding: 20px;
    }
    
    .online-users {
        background: rgba(16, 185, 129, 0.1);
        border-left: 4px solid #10b981;
        padding: 10px 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .typing-indicator {
        padding: 10px;
        font-style: italic;
        color: #6b7280;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="fas fa-comments text-primary me-2"></i>Sports Council Chat
                        </h5>
                        <small class="text-muted">Connect with admins and fellow students</small>
                    </div>
                    <div class="online-users">
                        <i class="fas fa-circle text-success me-2"></i>
                        <small>You are online as <strong>{{ current_user.name }}</strong></small>
                    </div>
                </div>
            </div>
            
            <div class="chat-container">
                <!-- Chat Messages -->
                <div class="chat-messages" id="messages">
                    {% for message in messages %}
                    <div class="message {{ 'own' if message.user_id == current_user.id else 'admin' if message.is_admin else 'other' }}">
                        <div class="message-bubble">
                            <div class="message-content">{{ message.message }}</div>
                        </div>
                        <div class="message-info">
                            {% if message.user_id != current_user.id %}
                                <strong>{{ message.name }}</strong>
                                {% if message.is_admin %}
                                    <i class="fas fa-crown text-warning ms-1" title="Admin"></i>
                                {% endif %}
                                •
                            {% endif %}
                            {{ message.created_at }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Typing Indicator -->
                <div class="typing-indicator d-none" id="typingIndicator">
                    <i class="fas fa-ellipsis-h"></i> Someone is typing...
                </div>
                
                <!-- Chat Input -->
                <div class="chat-input">
                    <form id="messageForm" class="d-flex">
                        <input type="text" class="form-control me-3" id="messageInput" 
                               placeholder="Type your message..." autocomplete="off" required>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                    <small class="text-muted mt-2 d-block">
                        <i class="fas fa-info-circle me-1"></i>
                        Please be respectful and follow college guidelines in your communications.
                    </small>
                </div>
            </div>
        </div>
        
        <!-- Chat Guidelines -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-rules text-warning me-2"></i>Chat Guidelines
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-success">
                            <i class="fas fa-check me-2"></i>Do's
                        </h6>
                        <ul class="small">
                            <li>Ask questions about turf bookings</li>
                            <li>Share relevant sports announcements</li>
                            <li>Be respectful to all members</li>
                            <li>Use appropriate language</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-danger">
                            <i class="fas fa-times me-2"></i>Don'ts
                        </h6>
                        <ul class="small">
                            <li>Share personal/sensitive information</li>
                            <li>Use offensive or inappropriate language</li>
                            <li>Spam or flood the chat</li>
                            <li>Discuss non-sports related topics</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Socket.IO -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    const socket = io();
    const messages = document.getElementById('messages');
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const typingIndicator = document.getElementById('typingIndicator');
    
    let typingTimer;
    let isTyping = false;
    
    // Join chat room
    socket.emit('join', {});
    
    // Handle form submission
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message) {
            socket.emit('message', { message: message });
            messageInput.value = '';
            
            // Stop typing indicator
            if (isTyping) {
                socket.emit('stop_typing');
                isTyping = false;
            }
        }
    });
    
    // Handle typing indicator
    messageInput.addEventListener('input', function() {
        if (!isTyping) {
            socket.emit('typing');
            isTyping = true;
        }
        
        clearTimeout(typingTimer);
        typingTimer = setTimeout(function() {
            socket.emit('stop_typing');
            isTyping = false;
        }, 1000);
    });
    
    // Receive messages
    socket.on('message', function(data) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${data.name === '{{ current_user.name }}' ? 'own' : data.is_admin ? 'admin' : 'other'}`;
        
        messageDiv.innerHTML = `
            <div class="message-bubble">
                <div class="message-content">${escapeHtml(data.message)}</div>
            </div>
            <div class="message-info">
                ${data.name !== '{{ current_user.name }}' ? `<strong>${data.name}</strong> ${data.is_admin ? '<i class="fas fa-crown text-warning ms-1" title="Admin"></i>' : ''} •` : ''}
                ${data.timestamp}
            </div>
        `;
        
        messages.appendChild(messageDiv);
        messages.scrollTop = messages.scrollHeight;
    });
    
    // Handle status messages
    socket.on('status', function(data) {
        const statusDiv = document.createElement('div');
        statusDiv.className = 'text-center text-muted small my-2';
        statusDiv.innerHTML = `<em>${data.msg}</em>`;
        messages.appendChild(statusDiv);
        messages.scrollTop = messages.scrollHeight;
    });
    
    // Handle typing indicators
    socket.on('typing', function(data) {
        if (data.name !== '{{ current_user.name }}') {
            typingIndicator.textContent = `${data.name} is typing...`;
            typingIndicator.classList.remove('d-none');
        }
    });
    
    socket.on('stop_typing', function() {
        typingIndicator.classList.add('d-none');
    });
    
    // Utility function to escape HTML
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }
    
    // Auto-scroll to bottom on page load
    window.addEventListener('load', function() {
        messages.scrollTop = messages.scrollHeight;
    });
    
    // Handle disconnect
    window.addEventListener('beforeunload', function() {
        socket.emit('leave', {});
    });
</script>
{% endblock %}